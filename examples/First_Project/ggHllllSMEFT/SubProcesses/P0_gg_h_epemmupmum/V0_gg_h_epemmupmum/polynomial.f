      MODULE POLYNOMIAL_CONSTANTS
      IMPLICIT NONE
      INCLUDE 'coef_specs.inc'
      INCLUDE 'loop_max_coefs.inc'

C     Map associating a rank to each coefficient position
      INTEGER COEFTORANK_MAP(0:LOOPMAXCOEFS-1)
      DATA COEFTORANK_MAP(0:0)/1*0/
      DATA COEFTORANK_MAP(1:4)/4*1/
      DATA COEFTORANK_MAP(5:14)/10*2/
      DATA COEFTORANK_MAP(15:34)/20*3/
      DATA COEFTORANK_MAP(35:69)/35*4/

C     Map defining the number of coefficients for a symmetric tensor
C      of a given rank
      INTEGER NCOEF_R(0:4)
      DATA NCOEF_R/1,5,15,35,70/

C     Map defining the coef position resulting from the multiplication
C      of two lower rank coefs.
      INTEGER COMB_COEF_POS(0:LOOPMAXCOEFS-1,0:14)
      DATA COMB_COEF_POS(  0,  0: 14) /  0,  1,  2,  3,  4,  5,  6,  7
     $ ,  8,  9, 10, 11, 12, 13, 14/
      DATA COMB_COEF_POS(  1,  0: 14) /  1,  5,  6,  8, 11, 15, 16, 17
     $ , 19, 20, 22, 25, 26, 28, 31/
      DATA COMB_COEF_POS(  2,  0: 14) /  2,  6,  7,  9, 12, 16, 17, 18
     $ , 20, 21, 23, 26, 27, 29, 32/
      DATA COMB_COEF_POS(  3,  0: 14) /  3,  8,  9, 10, 13, 19, 20, 21
     $ , 22, 23, 24, 28, 29, 30, 33/
      DATA COMB_COEF_POS(  4,  0: 14) /  4, 11, 12, 13, 14, 25, 26, 27
     $ , 28, 29, 30, 31, 32, 33, 34/
      DATA COMB_COEF_POS(  5,  0: 14) /  5, 15, 16, 19, 25, 35, 36, 37
     $ , 40, 41, 44, 50, 51, 54, 60/
      DATA COMB_COEF_POS(  6,  0: 14) /  6, 16, 17, 20, 26, 36, 37, 38
     $ , 41, 42, 45, 51, 52, 55, 61/
      DATA COMB_COEF_POS(  7,  0: 14) /  7, 17, 18, 21, 27, 37, 38, 39
     $ , 42, 43, 46, 52, 53, 56, 62/
      DATA COMB_COEF_POS(  8,  0: 14) /  8, 19, 20, 22, 28, 40, 41, 42
     $ , 44, 45, 47, 54, 55, 57, 63/
      DATA COMB_COEF_POS(  9,  0: 14) /  9, 20, 21, 23, 29, 41, 42, 43
     $ , 45, 46, 48, 55, 56, 58, 64/
      DATA COMB_COEF_POS( 10,  0: 14) / 10, 22, 23, 24, 30, 44, 45, 46
     $ , 47, 48, 49, 57, 58, 59, 65/
      DATA COMB_COEF_POS( 11,  0: 14) / 11, 25, 26, 28, 31, 50, 51, 52
     $ , 54, 55, 57, 60, 61, 63, 66/
      DATA COMB_COEF_POS( 12,  0: 14) / 12, 26, 27, 29, 32, 51, 52, 53
     $ , 55, 56, 58, 61, 62, 64, 67/
      DATA COMB_COEF_POS( 13,  0: 14) / 13, 28, 29, 30, 33, 54, 55, 56
     $ , 57, 58, 59, 63, 64, 65, 68/
      DATA COMB_COEF_POS( 14,  0: 14) / 14, 31, 32, 33, 34, 60, 61, 62
     $ , 63, 64, 65, 66, 67, 68, 69/
      DATA COMB_COEF_POS( 15,  0: 14) / 15, 35, 36, 40, 50, 70, 71, 72
     $ , 76, 77, 81, 91, 92, 96,106/
      DATA COMB_COEF_POS( 16,  0: 14) / 16, 36, 37, 41, 51, 71, 72, 73
     $ , 77, 78, 82, 92, 93, 97,107/
      DATA COMB_COEF_POS( 17,  0: 14) / 17, 37, 38, 42, 52, 72, 73, 74
     $ , 78, 79, 83, 93, 94, 98,108/
      DATA COMB_COEF_POS( 18,  0: 14) / 18, 38, 39, 43, 53, 73, 74, 75
     $ , 79, 80, 84, 94, 95, 99,109/
      DATA COMB_COEF_POS( 19,  0: 14) / 19, 40, 41, 44, 54, 76, 77, 78
     $ , 81, 82, 85, 96, 97,100,110/
      DATA COMB_COEF_POS( 20,  0: 14) / 20, 41, 42, 45, 55, 77, 78, 79
     $ , 82, 83, 86, 97, 98,101,111/
      DATA COMB_COEF_POS( 21,  0: 14) / 21, 42, 43, 46, 56, 78, 79, 80
     $ , 83, 84, 87, 98, 99,102,112/
      DATA COMB_COEF_POS( 22,  0: 14) / 22, 44, 45, 47, 57, 81, 82, 83
     $ , 85, 86, 88,100,101,103,113/
      DATA COMB_COEF_POS( 23,  0: 14) / 23, 45, 46, 48, 58, 82, 83, 84
     $ , 86, 87, 89,101,102,104,114/
      DATA COMB_COEF_POS( 24,  0: 14) / 24, 47, 48, 49, 59, 85, 86, 87
     $ , 88, 89, 90,103,104,105,115/
      DATA COMB_COEF_POS( 25,  0: 14) / 25, 50, 51, 54, 60, 91, 92, 93
     $ , 96, 97,100,106,107,110,116/
      DATA COMB_COEF_POS( 26,  0: 14) / 26, 51, 52, 55, 61, 92, 93, 94
     $ , 97, 98,101,107,108,111,117/
      DATA COMB_COEF_POS( 27,  0: 14) / 27, 52, 53, 56, 62, 93, 94, 95
     $ , 98, 99,102,108,109,112,118/
      DATA COMB_COEF_POS( 28,  0: 14) / 28, 54, 55, 57, 63, 96, 97, 98
     $ ,100,101,103,110,111,113,119/
      DATA COMB_COEF_POS( 29,  0: 14) / 29, 55, 56, 58, 64, 97, 98, 99
     $ ,101,102,104,111,112,114,120/
      DATA COMB_COEF_POS( 30,  0: 14) / 30, 57, 58, 59, 65,100,101,102
     $ ,103,104,105,113,114,115,121/
      DATA COMB_COEF_POS( 31,  0: 14) / 31, 60, 61, 63, 66,106,107,108
     $ ,110,111,113,116,117,119,122/
      DATA COMB_COEF_POS( 32,  0: 14) / 32, 61, 62, 64, 67,107,108,109
     $ ,111,112,114,117,118,120,123/
      DATA COMB_COEF_POS( 33,  0: 14) / 33, 63, 64, 65, 68,110,111,112
     $ ,113,114,115,119,120,121,124/
      DATA COMB_COEF_POS( 34,  0: 14) / 34, 66, 67, 68, 69,116,117,118
     $ ,119,120,121,122,123,124,125/
      DATA COMB_COEF_POS( 35,  0: 14) / 35, 70, 71, 76, 91,126,127,128
     $ ,133,134,139,154,155,160,175/
      DATA COMB_COEF_POS( 36,  0: 14) / 36, 71, 72, 77, 92,127,128,129
     $ ,134,135,140,155,156,161,176/
      DATA COMB_COEF_POS( 37,  0: 14) / 37, 72, 73, 78, 93,128,129,130
     $ ,135,136,141,156,157,162,177/
      DATA COMB_COEF_POS( 38,  0: 14) / 38, 73, 74, 79, 94,129,130,131
     $ ,136,137,142,157,158,163,178/
      DATA COMB_COEF_POS( 39,  0: 14) / 39, 74, 75, 80, 95,130,131,132
     $ ,137,138,143,158,159,164,179/
      DATA COMB_COEF_POS( 40,  0: 14) / 40, 76, 77, 81, 96,133,134,135
     $ ,139,140,144,160,161,165,180/
      DATA COMB_COEF_POS( 41,  0: 14) / 41, 77, 78, 82, 97,134,135,136
     $ ,140,141,145,161,162,166,181/
      DATA COMB_COEF_POS( 42,  0: 14) / 42, 78, 79, 83, 98,135,136,137
     $ ,141,142,146,162,163,167,182/
      DATA COMB_COEF_POS( 43,  0: 14) / 43, 79, 80, 84, 99,136,137,138
     $ ,142,143,147,163,164,168,183/
      DATA COMB_COEF_POS( 44,  0: 14) / 44, 81, 82, 85,100,139,140,141
     $ ,144,145,148,165,166,169,184/
      DATA COMB_COEF_POS( 45,  0: 14) / 45, 82, 83, 86,101,140,141,142
     $ ,145,146,149,166,167,170,185/
      DATA COMB_COEF_POS( 46,  0: 14) / 46, 83, 84, 87,102,141,142,143
     $ ,146,147,150,167,168,171,186/
      DATA COMB_COEF_POS( 47,  0: 14) / 47, 85, 86, 88,103,144,145,146
     $ ,148,149,151,169,170,172,187/
      DATA COMB_COEF_POS( 48,  0: 14) / 48, 86, 87, 89,104,145,146,147
     $ ,149,150,152,170,171,173,188/
      DATA COMB_COEF_POS( 49,  0: 14) / 49, 88, 89, 90,105,148,149,150
     $ ,151,152,153,172,173,174,189/
      DATA COMB_COEF_POS( 50,  0: 14) / 50, 91, 92, 96,106,154,155,156
     $ ,160,161,165,175,176,180,190/
      DATA COMB_COEF_POS( 51,  0: 14) / 51, 92, 93, 97,107,155,156,157
     $ ,161,162,166,176,177,181,191/
      DATA COMB_COEF_POS( 52,  0: 14) / 52, 93, 94, 98,108,156,157,158
     $ ,162,163,167,177,178,182,192/
      DATA COMB_COEF_POS( 53,  0: 14) / 53, 94, 95, 99,109,157,158,159
     $ ,163,164,168,178,179,183,193/
      DATA COMB_COEF_POS( 54,  0: 14) / 54, 96, 97,100,110,160,161,162
     $ ,165,166,169,180,181,184,194/
      DATA COMB_COEF_POS( 55,  0: 14) / 55, 97, 98,101,111,161,162,163
     $ ,166,167,170,181,182,185,195/
      DATA COMB_COEF_POS( 56,  0: 14) / 56, 98, 99,102,112,162,163,164
     $ ,167,168,171,182,183,186,196/
      DATA COMB_COEF_POS( 57,  0: 14) / 57,100,101,103,113,165,166,167
     $ ,169,170,172,184,185,187,197/
      DATA COMB_COEF_POS( 58,  0: 14) / 58,101,102,104,114,166,167,168
     $ ,170,171,173,185,186,188,198/
      DATA COMB_COEF_POS( 59,  0: 14) / 59,103,104,105,115,169,170,171
     $ ,172,173,174,187,188,189,199/
      DATA COMB_COEF_POS( 60,  0: 14) / 60,106,107,110,116,175,176,177
     $ ,180,181,184,190,191,194,200/
      DATA COMB_COEF_POS( 61,  0: 14) / 61,107,108,111,117,176,177,178
     $ ,181,182,185,191,192,195,201/
      DATA COMB_COEF_POS( 62,  0: 14) / 62,108,109,112,118,177,178,179
     $ ,182,183,186,192,193,196,202/
      DATA COMB_COEF_POS( 63,  0: 14) / 63,110,111,113,119,180,181,182
     $ ,184,185,187,194,195,197,203/
      DATA COMB_COEF_POS( 64,  0: 14) / 64,111,112,114,120,181,182,183
     $ ,185,186,188,195,196,198,204/
      DATA COMB_COEF_POS( 65,  0: 14) / 65,113,114,115,121,184,185,186
     $ ,187,188,189,197,198,199,205/
      DATA COMB_COEF_POS( 66,  0: 14) / 66,116,117,119,122,190,191,192
     $ ,194,195,197,200,201,203,206/
      DATA COMB_COEF_POS( 67,  0: 14) / 67,117,118,120,123,191,192,193
     $ ,195,196,198,201,202,204,207/
      DATA COMB_COEF_POS( 68,  0: 14) / 68,119,120,121,124,194,195,196
     $ ,197,198,199,203,204,205,208/
      DATA COMB_COEF_POS( 69,  0: 14) / 69,122,123,124,125,200,201,202
     $ ,203,204,205,206,207,208,209/

      END MODULE POLYNOMIAL_CONSTANTS


C     THE SUBROUTINE TO CREATE THE COEFFICIENTS FROM LAST LOOP WF AND 
C     MULTIPLY BY THE BORN

      SUBROUTINE CREATE_LOOP_COEFS(LOOP_WF,RANK,LCUT_SIZE
     $ ,LOOP_GROUP_NUMBER,SYMFACT,MULTIPLIER,COLOR_ID,HELCONFIG)
      USE POLYNOMIAL_CONSTANTS
      IMPLICIT NONE
C     
C     CONSTANTS 
C     
      INTEGER NBORNAMPS
      PARAMETER (NBORNAMPS=1)
      REAL*8 ZERO,ONE
      PARAMETER (ZERO=0.0D0,ONE=1.0D0)
      COMPLEX*16 IMAG1
      PARAMETER (IMAG1=(ZERO,ONE))
      COMPLEX*16 CMPLX_ZERO
      PARAMETER (CMPLX_ZERO=(ZERO,ZERO))
      INTEGER    NCOLORROWS
      PARAMETER (NCOLORROWS=63)
      INTEGER    NLOOPGROUPS
      PARAMETER (NLOOPGROUPS=9)
      INTEGER    NCOMB
      PARAMETER (NCOMB=64)
C     These are constants related to the split orders
      INTEGER    NSO, NSQUAREDSO, NAMPSO
      PARAMETER (NSO=1, NSQUAREDSO=1, NAMPSO=2)
C     
C     ARGUMENTS 
C     
      COMPLEX*16 LOOP_WF(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      INTEGER RANK, COLOR_ID, SYMFACT, MULTIPLIER, LCUT_SIZE,
     $  HELCONFIG, LOOP_GROUP_NUMBER
C     
C     LOCAL VARIABLES 
C     
      COMPLEX*16 CFTOT
      COMPLEX*16 CONST(NAMPSO)
      INTEGER I,J
C     
C     FUNCTIONS
C     
      INTEGER ML5SOINDEX_FOR_BORN_AMP, ML5SOINDEX_FOR_LOOP_AMP,
     $  ML5SQSOINDEX
C     
C     GLOBAL VARIABLES
C     
      INTEGER CF_D(NCOLORROWS,NBORNAMPS)
      INTEGER CF_N(NCOLORROWS,NBORNAMPS)
      COMMON/CF/CF_D,CF_N

      LOGICAL CHECKPHASE
      LOGICAL HELDOUBLECHECKED
      COMMON/INIT/CHECKPHASE, HELDOUBLECHECKED

      INTEGER HELOFFSET
      INTEGER GOODHEL(NCOMB)
      LOGICAL GOODAMP(NSQUAREDSO,NLOOPGROUPS)
      COMMON/FILTERS/GOODAMP,GOODHEL,HELOFFSET

      COMPLEX*16 LOOPCOEFS(0:LOOPMAXCOEFS-1,NSQUAREDSO,NLOOPGROUPS)
      COMMON/LCOEFS/LOOPCOEFS

      INTEGER HELPICKED
      COMMON/HELCHOICE/HELPICKED

      COMPLEX*16 AMP(NBORNAMPS)
      COMMON/AMPS/AMP

      DO I=1,NAMPSO
        CONST(I)=CMPLX_ZERO
      ENDDO

      DO I=1,NBORNAMPS
        CFTOT=CMPLX(CF_N(COLOR_ID,I)/(ONE*ABS(CF_D(COLOR_ID,I))),ZERO
     $   ,KIND=8)
        IF(CF_D(COLOR_ID,I).LT.0) CFTOT=CFTOT*IMAG1
        CONST(ML5SOINDEX_FOR_BORN_AMP(I))=CONST(ML5SOINDEX_FOR_BORN_AMP
     $(I))+CFTOT*CONJG(AMP(I))
      ENDDO

      DO I=1,NAMPSO
        IF (CONST(I).NE.CMPLX_ZERO) THEN
          CONST(I)=(CONST(I)*MULTIPLIER)/SYMFACT
          IF (.NOT.CHECKPHASE.AND.HELDOUBLECHECKED.AND.HELPICKED.EQ.-1)
     $      THEN
            CONST(I)=CONST(I)*GOODHEL(HELCONFIG)
          ENDIF
          CALL MERGE_WL(LOOP_WF,RANK,LCUT_SIZE,CONST(I),LOOPCOEFS(0
     $     ,ML5SQSOINDEX(I,ML5SOINDEX_FOR_LOOP_AMP(COLOR_ID))
     $     ,LOOP_GROUP_NUMBER))
        ENDIF
      ENDDO

      END


C     Now the routines to update the wavefunctions



C     THE SUBROUTINE TO CREATE THE COEFFICIENTS FROM LAST LOOP WF AND 
C     MULTIPLY BY THE BORN

      SUBROUTINE MP_CREATE_LOOP_COEFS(LOOP_WF,RANK,LCUT_SIZE
     $ ,LOOP_GROUP_NUMBER,SYMFACT,MULTIPLIER,COLOR_ID,HELCONFIG)
      USE POLYNOMIAL_CONSTANTS
      IMPLICIT NONE
C     
C     CONSTANTS 
C     
      INTEGER NBORNAMPS
      PARAMETER (NBORNAMPS=1)
      REAL*16 ZERO,ONE
      PARAMETER (ZERO=0.0E0_16,ONE=1.0E0_16)
      COMPLEX*32 IMAG1
      PARAMETER (IMAG1=(ZERO,ONE))
      COMPLEX*32 CMPLX_ZERO
      PARAMETER (CMPLX_ZERO=(ZERO,ZERO))
      INTEGER    NCOLORROWS
      PARAMETER (NCOLORROWS=63)
      INTEGER    NLOOPGROUPS
      PARAMETER (NLOOPGROUPS=9)
      INTEGER    NCOMB
      PARAMETER (NCOMB=64)
C     These are constants related to the split orders
      INTEGER    NSO, NSQUAREDSO, NAMPSO
      PARAMETER (NSO=1, NSQUAREDSO=1, NAMPSO=2)
C     
C     ARGUMENTS 
C     
      COMPLEX*32 LOOP_WF(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      INTEGER RANK, COLOR_ID, SYMFACT, MULTIPLIER, LCUT_SIZE,
     $  HELCONFIG, LOOP_GROUP_NUMBER
C     
C     LOCAL VARIABLES 
C     
      COMPLEX*32 CFTOT
      COMPLEX*32 CONST(NAMPSO)
      INTEGER I,J
C     
C     FUNCTIONS
C     
      INTEGER ML5SOINDEX_FOR_BORN_AMP, ML5SOINDEX_FOR_LOOP_AMP,
     $  ML5SQSOINDEX
C     
C     GLOBAL VARIABLES
C     
      INTEGER CF_D(NCOLORROWS,NBORNAMPS)
      INTEGER CF_N(NCOLORROWS,NBORNAMPS)
      COMMON/CF/CF_D,CF_N

      LOGICAL CHECKPHASE
      LOGICAL HELDOUBLECHECKED
      COMMON/INIT/CHECKPHASE, HELDOUBLECHECKED

      INTEGER HELOFFSET
      INTEGER GOODHEL(NCOMB)
      LOGICAL GOODAMP(NSQUAREDSO,NLOOPGROUPS)
      COMMON/FILTERS/GOODAMP,GOODHEL,HELOFFSET

      COMPLEX*32 LOOPCOEFS(0:LOOPMAXCOEFS-1,NSQUAREDSO,NLOOPGROUPS)
      COMMON/MP_LCOEFS/LOOPCOEFS

      INTEGER HELPICKED
      COMMON/HELCHOICE/HELPICKED

      COMPLEX*32 AMP(NBORNAMPS)
      COMMON/MP_AMPS/AMP

      DO I=1,NAMPSO
        CONST(I)=CMPLX_ZERO
      ENDDO

      DO I=1,NBORNAMPS
        CFTOT=CMPLX(CF_N(COLOR_ID,I)/(ONE*ABS(CF_D(COLOR_ID,I))),ZERO
     $   ,KIND=16)
        IF(CF_D(COLOR_ID,I).LT.0) CFTOT=CFTOT*IMAG1
        CONST(ML5SOINDEX_FOR_BORN_AMP(I))=CONST(ML5SOINDEX_FOR_BORN_AMP
     $(I))+CFTOT*CONJG(AMP(I))
      ENDDO

      DO I=1,NAMPSO
        IF (CONST(I).NE.CMPLX_ZERO) THEN
          CONST(I)=(CONST(I)*MULTIPLIER)/SYMFACT
          IF (.NOT.CHECKPHASE.AND.HELDOUBLECHECKED.AND.HELPICKED.EQ.-1)
     $      THEN
            CONST(I)=CONST(I)*GOODHEL(HELCONFIG)
          ENDIF
          CALL MP_MERGE_WL(LOOP_WF,RANK,LCUT_SIZE,CONST(I),LOOPCOEFS(0
     $     ,ML5SQSOINDEX(I,ML5SOINDEX_FOR_LOOP_AMP(COLOR_ID))
     $     ,LOOP_GROUP_NUMBER))
        ENDIF
      ENDDO

      END


C     Now the routines to update the wavefunctions



      SUBROUTINE EVAL_POLY(C,R,Q,OUT)
      USE POLYNOMIAL_CONSTANTS
      COMPLEX*16 C(0:LOOPMAXCOEFS-1)
      INTEGER R
      COMPLEX*16 Q(0:3)
      COMPLEX*16 OUT

      OUT=C(0)
      IF (R.GE.1) THEN
        OUT=OUT+C(1)*Q(0)+C(2)*Q(1)+C(3)*Q(2)+C(4)*Q(3)
      ENDIF
      IF (R.GE.2) THEN
        OUT=OUT+C(5)*Q(0)*Q(0)+C(6)*Q(0)*Q(1)+C(7)*Q(1)*Q(1)+C(8)*Q(0)
     $   *Q(2)+C(9)*Q(1)*Q(2)+C(10)*Q(2)*Q(2)+C(11)*Q(0)*Q(3)+C(12)
     $   *Q(1)*Q(3)+C(13)*Q(2)*Q(3)+C(14)*Q(3)*Q(3)
      ENDIF
      IF (R.GE.3) THEN
        OUT=OUT+C(15)*Q(0)*Q(0)*Q(0)+C(16)*Q(0)*Q(0)*Q(1)+C(17)*Q(0)
     $   *Q(1)*Q(1)+C(18)*Q(1)*Q(1)*Q(1)+C(19)*Q(0)*Q(0)*Q(2)+C(20)
     $   *Q(0)*Q(1)*Q(2)+C(21)*Q(1)*Q(1)*Q(2)+C(22)*Q(0)*Q(2)*Q(2)
     $   +C(23)*Q(1)*Q(2)*Q(2)+C(24)*Q(2)*Q(2)*Q(2)+C(25)*Q(0)*Q(0)
     $   *Q(3)+C(26)*Q(0)*Q(1)*Q(3)+C(27)*Q(1)*Q(1)*Q(3)+C(28)*Q(0)
     $   *Q(2)*Q(3)+C(29)*Q(1)*Q(2)*Q(3)+C(30)*Q(2)*Q(2)*Q(3)+C(31)
     $   *Q(0)*Q(3)*Q(3)+C(32)*Q(1)*Q(3)*Q(3)+C(33)*Q(2)*Q(3)*Q(3)
     $   +C(34)*Q(3)*Q(3)*Q(3)
      ENDIF
      IF (R.GE.4) THEN
        OUT=OUT+C(35)*Q(0)*Q(0)*Q(0)*Q(0)+C(36)*Q(0)*Q(0)*Q(0)*Q(1)
     $   +C(37)*Q(0)*Q(0)*Q(1)*Q(1)+C(38)*Q(0)*Q(1)*Q(1)*Q(1)+C(39)
     $   *Q(1)*Q(1)*Q(1)*Q(1)+C(40)*Q(0)*Q(0)*Q(0)*Q(2)+C(41)*Q(0)*Q(0)
     $   *Q(1)*Q(2)+C(42)*Q(0)*Q(1)*Q(1)*Q(2)+C(43)*Q(1)*Q(1)*Q(1)*Q(2)
     $   +C(44)*Q(0)*Q(0)*Q(2)*Q(2)+C(45)*Q(0)*Q(1)*Q(2)*Q(2)+C(46)
     $   *Q(1)*Q(1)*Q(2)*Q(2)+C(47)*Q(0)*Q(2)*Q(2)*Q(2)+C(48)*Q(1)*Q(2)
     $   *Q(2)*Q(2)+C(49)*Q(2)*Q(2)*Q(2)*Q(2)+C(50)*Q(0)*Q(0)*Q(0)*Q(3)
     $   +C(51)*Q(0)*Q(0)*Q(1)*Q(3)+C(52)*Q(0)*Q(1)*Q(1)*Q(3)+C(53)
     $   *Q(1)*Q(1)*Q(1)*Q(3)+C(54)*Q(0)*Q(0)*Q(2)*Q(3)+C(55)*Q(0)*Q(1)
     $   *Q(2)*Q(3)+C(56)*Q(1)*Q(1)*Q(2)*Q(3)+C(57)*Q(0)*Q(2)*Q(2)*Q(3)
     $   +C(58)*Q(1)*Q(2)*Q(2)*Q(3)+C(59)*Q(2)*Q(2)*Q(2)*Q(3)+C(60)
     $   *Q(0)*Q(0)*Q(3)*Q(3)+C(61)*Q(0)*Q(1)*Q(3)*Q(3)+C(62)*Q(1)*Q(1)
     $   *Q(3)*Q(3)+C(63)*Q(0)*Q(2)*Q(3)*Q(3)+C(64)*Q(1)*Q(2)*Q(3)*Q(3)
        OUT=OUT+C(65)*Q(2)*Q(2)*Q(3)*Q(3)+C(66)*Q(0)*Q(3)*Q(3)*Q(3)
     $   +C(67)*Q(1)*Q(3)*Q(3)*Q(3)+C(68)*Q(2)*Q(3)*Q(3)*Q(3)+C(69)
     $   *Q(3)*Q(3)*Q(3)*Q(3)
      ENDIF
      END

      SUBROUTINE MP_EVAL_POLY(C,R,Q,OUT)
      USE POLYNOMIAL_CONSTANTS
      COMPLEX*32 C(0:LOOPMAXCOEFS-1)
      INTEGER R
      COMPLEX*32 Q(0:3)
      COMPLEX*32 OUT

      OUT=C(0)
      IF (R.GE.1) THEN
        OUT=OUT+C(1)*Q(0)+C(2)*Q(1)+C(3)*Q(2)+C(4)*Q(3)
      ENDIF
      IF (R.GE.2) THEN
        OUT=OUT+C(5)*Q(0)*Q(0)+C(6)*Q(0)*Q(1)+C(7)*Q(1)*Q(1)+C(8)*Q(0)
     $   *Q(2)+C(9)*Q(1)*Q(2)+C(10)*Q(2)*Q(2)+C(11)*Q(0)*Q(3)+C(12)
     $   *Q(1)*Q(3)+C(13)*Q(2)*Q(3)+C(14)*Q(3)*Q(3)
      ENDIF
      IF (R.GE.3) THEN
        OUT=OUT+C(15)*Q(0)*Q(0)*Q(0)+C(16)*Q(0)*Q(0)*Q(1)+C(17)*Q(0)
     $   *Q(1)*Q(1)+C(18)*Q(1)*Q(1)*Q(1)+C(19)*Q(0)*Q(0)*Q(2)+C(20)
     $   *Q(0)*Q(1)*Q(2)+C(21)*Q(1)*Q(1)*Q(2)+C(22)*Q(0)*Q(2)*Q(2)
     $   +C(23)*Q(1)*Q(2)*Q(2)+C(24)*Q(2)*Q(2)*Q(2)+C(25)*Q(0)*Q(0)
     $   *Q(3)+C(26)*Q(0)*Q(1)*Q(3)+C(27)*Q(1)*Q(1)*Q(3)+C(28)*Q(0)
     $   *Q(2)*Q(3)+C(29)*Q(1)*Q(2)*Q(3)+C(30)*Q(2)*Q(2)*Q(3)+C(31)
     $   *Q(0)*Q(3)*Q(3)+C(32)*Q(1)*Q(3)*Q(3)+C(33)*Q(2)*Q(3)*Q(3)
     $   +C(34)*Q(3)*Q(3)*Q(3)
      ENDIF
      IF (R.GE.4) THEN
        OUT=OUT+C(35)*Q(0)*Q(0)*Q(0)*Q(0)+C(36)*Q(0)*Q(0)*Q(0)*Q(1)
     $   +C(37)*Q(0)*Q(0)*Q(1)*Q(1)+C(38)*Q(0)*Q(1)*Q(1)*Q(1)+C(39)
     $   *Q(1)*Q(1)*Q(1)*Q(1)+C(40)*Q(0)*Q(0)*Q(0)*Q(2)+C(41)*Q(0)*Q(0)
     $   *Q(1)*Q(2)+C(42)*Q(0)*Q(1)*Q(1)*Q(2)+C(43)*Q(1)*Q(1)*Q(1)*Q(2)
     $   +C(44)*Q(0)*Q(0)*Q(2)*Q(2)+C(45)*Q(0)*Q(1)*Q(2)*Q(2)+C(46)
     $   *Q(1)*Q(1)*Q(2)*Q(2)+C(47)*Q(0)*Q(2)*Q(2)*Q(2)+C(48)*Q(1)*Q(2)
     $   *Q(2)*Q(2)+C(49)*Q(2)*Q(2)*Q(2)*Q(2)+C(50)*Q(0)*Q(0)*Q(0)*Q(3)
     $   +C(51)*Q(0)*Q(0)*Q(1)*Q(3)+C(52)*Q(0)*Q(1)*Q(1)*Q(3)+C(53)
     $   *Q(1)*Q(1)*Q(1)*Q(3)+C(54)*Q(0)*Q(0)*Q(2)*Q(3)+C(55)*Q(0)*Q(1)
     $   *Q(2)*Q(3)+C(56)*Q(1)*Q(1)*Q(2)*Q(3)+C(57)*Q(0)*Q(2)*Q(2)*Q(3)
     $   +C(58)*Q(1)*Q(2)*Q(2)*Q(3)+C(59)*Q(2)*Q(2)*Q(2)*Q(3)+C(60)
     $   *Q(0)*Q(0)*Q(3)*Q(3)+C(61)*Q(0)*Q(1)*Q(3)*Q(3)+C(62)*Q(1)*Q(1)
     $   *Q(3)*Q(3)+C(63)*Q(0)*Q(2)*Q(3)*Q(3)+C(64)*Q(1)*Q(2)*Q(3)*Q(3)
        OUT=OUT+C(65)*Q(2)*Q(2)*Q(3)*Q(3)+C(66)*Q(0)*Q(3)*Q(3)*Q(3)
     $   +C(67)*Q(1)*Q(3)*Q(3)*Q(3)+C(68)*Q(2)*Q(3)*Q(3)*Q(3)+C(69)
     $   *Q(3)*Q(3)*Q(3)*Q(3)
      ENDIF
      END

      SUBROUTINE ADD_COEFS(A,RA,B,RB)
      USE POLYNOMIAL_CONSTANTS
      INTEGER I
      COMPLEX*16 A(0:LOOPMAXCOEFS-1),B(0:LOOPMAXCOEFS-1)
      INTEGER RA,RB

      DO I=0,NCOEF_R(RB)-1
        A(I)=A(I)+B(I)
      ENDDO
      END

      SUBROUTINE MP_ADD_COEFS(A,RA,B,RB)
      USE POLYNOMIAL_CONSTANTS
      INTEGER I
      COMPLEX*32 A(0:LOOPMAXCOEFS-1),B(0:LOOPMAXCOEFS-1)
      INTEGER RA,RB

      DO I=0,NCOEF_R(RB)-1
        A(I)=A(I)+B(I)
      ENDDO
      END

      SUBROUTINE MERGE_WL(WL,R,LCUT_SIZE,CONST,OUT)
      USE POLYNOMIAL_CONSTANTS
      INTEGER I,J
      COMPLEX*16 WL(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      INTEGER R,LCUT_SIZE
      COMPLEX*16 CONST
      COMPLEX*16 OUT(0:LOOPMAXCOEFS-1)

      DO I=1,LCUT_SIZE
        DO J=0,NCOEF_R(R)-1
          OUT(J)=OUT(J)+WL(I,J,I)*CONST
        ENDDO
      ENDDO
      END

      SUBROUTINE MP_MERGE_WL(WL,R,LCUT_SIZE,CONST,OUT)
      USE POLYNOMIAL_CONSTANTS
      INTEGER I,J
      COMPLEX*32 WL(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      INTEGER R,LCUT_SIZE
      COMPLEX*32 CONST
      COMPLEX*32 OUT(0:LOOPMAXCOEFS-1)

      DO I=1,LCUT_SIZE
        DO J=0,NCOEF_R(R)-1
          OUT(J)=OUT(J)+WL(I,J,I)*CONST
        ENDDO
      ENDDO
      END

      SUBROUTINE UPDATE_WL_0_1(A,LCUT_SIZE,B,IN_SIZE,OUT_SIZE,OUT)
      USE POLYNOMIAL_CONSTANTS
      INTEGER I,J,K
      COMPLEX*16 A(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*16 B(MAXLWFSIZE,0:VERTEXMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*16 OUT(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      INTEGER LCUT_SIZE,IN_SIZE,OUT_SIZE

      DO I=1,LCUT_SIZE
        DO J=1,OUT_SIZE
          DO K=0,4
            OUT(J,K,I)=(0.0D0,0.0D0)
          ENDDO
          DO K=1,IN_SIZE
            OUT(J,0,I)=OUT(J,0,I)+A(K,0,I)*B(J,0,K)
            OUT(J,1,I)=OUT(J,1,I)+A(K,0,I)*B(J,1,K)
            OUT(J,2,I)=OUT(J,2,I)+A(K,0,I)*B(J,2,K)
            OUT(J,3,I)=OUT(J,3,I)+A(K,0,I)*B(J,3,K)
            OUT(J,4,I)=OUT(J,4,I)+A(K,0,I)*B(J,4,K)
          ENDDO
        ENDDO
      ENDDO
      END

      SUBROUTINE MP_UPDATE_WL_0_1(A,LCUT_SIZE,B,IN_SIZE,OUT_SIZE,OUT)
      USE POLYNOMIAL_CONSTANTS
      INTEGER I,J,K
      COMPLEX*32 A(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*32 B(MAXLWFSIZE,0:VERTEXMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*32 OUT(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      INTEGER LCUT_SIZE,IN_SIZE,OUT_SIZE

      DO I=1,LCUT_SIZE
        DO J=1,OUT_SIZE
          DO K=0,4
            OUT(J,K,I)=CMPLX(0.0E0_16,0.0E0_16,KIND=16)
          ENDDO
          DO K=1,IN_SIZE
            OUT(J,0,I)=OUT(J,0,I)+A(K,0,I)*B(J,0,K)
            OUT(J,1,I)=OUT(J,1,I)+A(K,0,I)*B(J,1,K)
            OUT(J,2,I)=OUT(J,2,I)+A(K,0,I)*B(J,2,K)
            OUT(J,3,I)=OUT(J,3,I)+A(K,0,I)*B(J,3,K)
            OUT(J,4,I)=OUT(J,4,I)+A(K,0,I)*B(J,4,K)
          ENDDO
        ENDDO
      ENDDO
      END

      SUBROUTINE UPDATE_WL_0_0(A,LCUT_SIZE,B,IN_SIZE,OUT_SIZE,OUT)
      USE POLYNOMIAL_CONSTANTS
      INTEGER I,J,K
      COMPLEX*16 A(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*16 B(MAXLWFSIZE,0:VERTEXMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*16 OUT(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      INTEGER LCUT_SIZE,IN_SIZE,OUT_SIZE

      DO I=1,LCUT_SIZE
        DO J=1,OUT_SIZE
          DO K=0,0
            OUT(J,K,I)=(0.0D0,0.0D0)
          ENDDO
          DO K=1,IN_SIZE
            OUT(J,0,I)=OUT(J,0,I)+A(K,0,I)*B(J,0,K)
          ENDDO
        ENDDO
      ENDDO
      END

      SUBROUTINE MP_UPDATE_WL_0_0(A,LCUT_SIZE,B,IN_SIZE,OUT_SIZE,OUT)
      USE POLYNOMIAL_CONSTANTS
      INTEGER I,J,K
      COMPLEX*32 A(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*32 B(MAXLWFSIZE,0:VERTEXMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*32 OUT(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      INTEGER LCUT_SIZE,IN_SIZE,OUT_SIZE

      DO I=1,LCUT_SIZE
        DO J=1,OUT_SIZE
          DO K=0,0
            OUT(J,K,I)=CMPLX(0.0E0_16,0.0E0_16,KIND=16)
          ENDDO
          DO K=1,IN_SIZE
            OUT(J,0,I)=OUT(J,0,I)+A(K,0,I)*B(J,0,K)
          ENDDO
        ENDDO
      ENDDO
      END

      SUBROUTINE UPDATE_WL_2_1(A,LCUT_SIZE,B,IN_SIZE,OUT_SIZE,OUT)
      USE POLYNOMIAL_CONSTANTS
      IMPLICIT NONE
      INTEGER I,J,K,L,M
      COMPLEX*16 A(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*16 B(MAXLWFSIZE,0:VERTEXMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*16 OUT(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      INTEGER LCUT_SIZE,IN_SIZE,OUT_SIZE
      INTEGER NEW_POSITION
      COMPLEX*16 UPDATER_COEF

C     Welcome to the computational heart of MadLoop...
      OUT(:,:,:)=(0.0D0,0.0D0)
      DO J=1,OUT_SIZE
        DO M=0,4
          DO K=1,IN_SIZE
            UPDATER_COEF = B(J,M,K)
            IF (UPDATER_COEF.EQ.(0.0D0,0.0D0)) CYCLE
            DO L=0,14
              NEW_POSITION = COMB_COEF_POS(L,M)
              DO I=1,LCUT_SIZE
                OUT(J,NEW_POSITION,I)=OUT(J,NEW_POSITION,I) + A(K,L,I)
     $           *UPDATER_COEF
              ENDDO
            ENDDO
          ENDDO
        ENDDO
      ENDDO

      END

      SUBROUTINE MP_UPDATE_WL_2_1(A,LCUT_SIZE,B,IN_SIZE,OUT_SIZE,OUT)
      USE POLYNOMIAL_CONSTANTS
      IMPLICIT NONE
      INTEGER I,J,K,L,M
      COMPLEX*32 A(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*32 B(MAXLWFSIZE,0:VERTEXMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*32 OUT(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      INTEGER LCUT_SIZE,IN_SIZE,OUT_SIZE
      INTEGER NEW_POSITION
      COMPLEX*32 UPDATER_COEF

C     Welcome to the computational heart of MadLoop...
      OUT(:,:,:)=CMPLX(0.0E0_16,0.0E0_16,KIND=16)
      DO J=1,OUT_SIZE
        DO M=0,4
          DO K=1,IN_SIZE
            UPDATER_COEF = B(J,M,K)
            IF (UPDATER_COEF.EQ.CMPLX(0.0E0_16,0.0E0_16,KIND=16)) CYCLE
            DO L=0,14
              NEW_POSITION = COMB_COEF_POS(L,M)
              DO I=1,LCUT_SIZE
                OUT(J,NEW_POSITION,I)=OUT(J,NEW_POSITION,I) + A(K,L,I)
     $           *UPDATER_COEF
              ENDDO
            ENDDO
          ENDDO
        ENDDO
      ENDDO

      END

      SUBROUTINE UPDATE_WL_1_1(A,LCUT_SIZE,B,IN_SIZE,OUT_SIZE,OUT)
      USE POLYNOMIAL_CONSTANTS
      INTEGER I,J,K
      COMPLEX*16 A(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*16 B(MAXLWFSIZE,0:VERTEXMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*16 OUT(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      INTEGER LCUT_SIZE,IN_SIZE,OUT_SIZE

      DO I=1,LCUT_SIZE
        DO J=1,OUT_SIZE
          DO K=0,14
            OUT(J,K,I)=(0.0D0,0.0D0)
          ENDDO
          DO K=1,IN_SIZE
            OUT(J,0,I)=OUT(J,0,I)+A(K,0,I)*B(J,0,K)
            OUT(J,1,I)=OUT(J,1,I)+A(K,0,I)*B(J,1,K)+A(K,1,I)*B(J,0,K)
            OUT(J,2,I)=OUT(J,2,I)+A(K,0,I)*B(J,2,K)+A(K,2,I)*B(J,0,K)
            OUT(J,3,I)=OUT(J,3,I)+A(K,0,I)*B(J,3,K)+A(K,3,I)*B(J,0,K)
            OUT(J,4,I)=OUT(J,4,I)+A(K,0,I)*B(J,4,K)+A(K,4,I)*B(J,0,K)
            OUT(J,5,I)=OUT(J,5,I)+A(K,1,I)*B(J,1,K)
            OUT(J,6,I)=OUT(J,6,I)+A(K,1,I)*B(J,2,K)+A(K,2,I)*B(J,1,K)
            OUT(J,7,I)=OUT(J,7,I)+A(K,2,I)*B(J,2,K)
            OUT(J,8,I)=OUT(J,8,I)+A(K,1,I)*B(J,3,K)+A(K,3,I)*B(J,1,K)
            OUT(J,9,I)=OUT(J,9,I)+A(K,2,I)*B(J,3,K)+A(K,3,I)*B(J,2,K)
            OUT(J,10,I)=OUT(J,10,I)+A(K,3,I)*B(J,3,K)
            OUT(J,11,I)=OUT(J,11,I)+A(K,1,I)*B(J,4,K)+A(K,4,I)*B(J,1,K)
            OUT(J,12,I)=OUT(J,12,I)+A(K,2,I)*B(J,4,K)+A(K,4,I)*B(J,2,K)
            OUT(J,13,I)=OUT(J,13,I)+A(K,3,I)*B(J,4,K)+A(K,4,I)*B(J,3,K)
            OUT(J,14,I)=OUT(J,14,I)+A(K,4,I)*B(J,4,K)
          ENDDO
        ENDDO
      ENDDO
      END

      SUBROUTINE MP_UPDATE_WL_1_1(A,LCUT_SIZE,B,IN_SIZE,OUT_SIZE,OUT)
      USE POLYNOMIAL_CONSTANTS
      INTEGER I,J,K
      COMPLEX*32 A(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*32 B(MAXLWFSIZE,0:VERTEXMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*32 OUT(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      INTEGER LCUT_SIZE,IN_SIZE,OUT_SIZE

      DO I=1,LCUT_SIZE
        DO J=1,OUT_SIZE
          DO K=0,14
            OUT(J,K,I)=CMPLX(0.0E0_16,0.0E0_16,KIND=16)
          ENDDO
          DO K=1,IN_SIZE
            OUT(J,0,I)=OUT(J,0,I)+A(K,0,I)*B(J,0,K)
            OUT(J,1,I)=OUT(J,1,I)+A(K,0,I)*B(J,1,K)+A(K,1,I)*B(J,0,K)
            OUT(J,2,I)=OUT(J,2,I)+A(K,0,I)*B(J,2,K)+A(K,2,I)*B(J,0,K)
            OUT(J,3,I)=OUT(J,3,I)+A(K,0,I)*B(J,3,K)+A(K,3,I)*B(J,0,K)
            OUT(J,4,I)=OUT(J,4,I)+A(K,0,I)*B(J,4,K)+A(K,4,I)*B(J,0,K)
            OUT(J,5,I)=OUT(J,5,I)+A(K,1,I)*B(J,1,K)
            OUT(J,6,I)=OUT(J,6,I)+A(K,1,I)*B(J,2,K)+A(K,2,I)*B(J,1,K)
            OUT(J,7,I)=OUT(J,7,I)+A(K,2,I)*B(J,2,K)
            OUT(J,8,I)=OUT(J,8,I)+A(K,1,I)*B(J,3,K)+A(K,3,I)*B(J,1,K)
            OUT(J,9,I)=OUT(J,9,I)+A(K,2,I)*B(J,3,K)+A(K,3,I)*B(J,2,K)
            OUT(J,10,I)=OUT(J,10,I)+A(K,3,I)*B(J,3,K)
            OUT(J,11,I)=OUT(J,11,I)+A(K,1,I)*B(J,4,K)+A(K,4,I)*B(J,1,K)
            OUT(J,12,I)=OUT(J,12,I)+A(K,2,I)*B(J,4,K)+A(K,4,I)*B(J,2,K)
            OUT(J,13,I)=OUT(J,13,I)+A(K,3,I)*B(J,4,K)+A(K,4,I)*B(J,3,K)
            OUT(J,14,I)=OUT(J,14,I)+A(K,4,I)*B(J,4,K)
          ENDDO
        ENDDO
      ENDDO
      END

      SUBROUTINE UPDATE_WL_2_2(A,LCUT_SIZE,B,IN_SIZE,OUT_SIZE,OUT)
      USE POLYNOMIAL_CONSTANTS
      IMPLICIT NONE
      INTEGER I,J,K,L,M
      COMPLEX*16 A(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*16 B(MAXLWFSIZE,0:VERTEXMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*16 OUT(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      INTEGER LCUT_SIZE,IN_SIZE,OUT_SIZE
      INTEGER NEW_POSITION
      COMPLEX*16 UPDATER_COEF

C     Welcome to the computational heart of MadLoop...
      OUT(:,:,:)=(0.0D0,0.0D0)
      DO J=1,OUT_SIZE
        DO M=0,14
          DO K=1,IN_SIZE
            UPDATER_COEF = B(J,M,K)
            IF (UPDATER_COEF.EQ.(0.0D0,0.0D0)) CYCLE
            DO L=0,14
              NEW_POSITION = COMB_COEF_POS(L,M)
              DO I=1,LCUT_SIZE
                OUT(J,NEW_POSITION,I)=OUT(J,NEW_POSITION,I) + A(K,L,I)
     $           *UPDATER_COEF
              ENDDO
            ENDDO
          ENDDO
        ENDDO
      ENDDO

      END

      SUBROUTINE MP_UPDATE_WL_2_2(A,LCUT_SIZE,B,IN_SIZE,OUT_SIZE,OUT)
      USE POLYNOMIAL_CONSTANTS
      IMPLICIT NONE
      INTEGER I,J,K,L,M
      COMPLEX*32 A(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*32 B(MAXLWFSIZE,0:VERTEXMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*32 OUT(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      INTEGER LCUT_SIZE,IN_SIZE,OUT_SIZE
      INTEGER NEW_POSITION
      COMPLEX*32 UPDATER_COEF

C     Welcome to the computational heart of MadLoop...
      OUT(:,:,:)=CMPLX(0.0E0_16,0.0E0_16,KIND=16)
      DO J=1,OUT_SIZE
        DO M=0,14
          DO K=1,IN_SIZE
            UPDATER_COEF = B(J,M,K)
            IF (UPDATER_COEF.EQ.CMPLX(0.0E0_16,0.0E0_16,KIND=16)) CYCLE
            DO L=0,14
              NEW_POSITION = COMB_COEF_POS(L,M)
              DO I=1,LCUT_SIZE
                OUT(J,NEW_POSITION,I)=OUT(J,NEW_POSITION,I) + A(K,L,I)
     $           *UPDATER_COEF
              ENDDO
            ENDDO
          ENDDO
        ENDDO
      ENDDO

      END

      SUBROUTINE UPDATE_WL_0_2(A,LCUT_SIZE,B,IN_SIZE,OUT_SIZE,OUT)
      USE POLYNOMIAL_CONSTANTS
      INTEGER I,J,K
      COMPLEX*16 A(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*16 B(MAXLWFSIZE,0:VERTEXMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*16 OUT(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      INTEGER LCUT_SIZE,IN_SIZE,OUT_SIZE

      DO I=1,LCUT_SIZE
        DO J=1,OUT_SIZE
          DO K=0,14
            OUT(J,K,I)=(0.0D0,0.0D0)
          ENDDO
          DO K=1,IN_SIZE
            OUT(J,0,I)=OUT(J,0,I)+A(K,0,I)*B(J,0,K)
            OUT(J,1,I)=OUT(J,1,I)+A(K,0,I)*B(J,1,K)
            OUT(J,2,I)=OUT(J,2,I)+A(K,0,I)*B(J,2,K)
            OUT(J,3,I)=OUT(J,3,I)+A(K,0,I)*B(J,3,K)
            OUT(J,4,I)=OUT(J,4,I)+A(K,0,I)*B(J,4,K)
            OUT(J,5,I)=OUT(J,5,I)+A(K,0,I)*B(J,5,K)
            OUT(J,6,I)=OUT(J,6,I)+A(K,0,I)*B(J,6,K)
            OUT(J,7,I)=OUT(J,7,I)+A(K,0,I)*B(J,7,K)
            OUT(J,8,I)=OUT(J,8,I)+A(K,0,I)*B(J,8,K)
            OUT(J,9,I)=OUT(J,9,I)+A(K,0,I)*B(J,9,K)
            OUT(J,10,I)=OUT(J,10,I)+A(K,0,I)*B(J,10,K)
            OUT(J,11,I)=OUT(J,11,I)+A(K,0,I)*B(J,11,K)
            OUT(J,12,I)=OUT(J,12,I)+A(K,0,I)*B(J,12,K)
            OUT(J,13,I)=OUT(J,13,I)+A(K,0,I)*B(J,13,K)
            OUT(J,14,I)=OUT(J,14,I)+A(K,0,I)*B(J,14,K)
          ENDDO
        ENDDO
      ENDDO
      END

      SUBROUTINE MP_UPDATE_WL_0_2(A,LCUT_SIZE,B,IN_SIZE,OUT_SIZE,OUT)
      USE POLYNOMIAL_CONSTANTS
      INTEGER I,J,K
      COMPLEX*32 A(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*32 B(MAXLWFSIZE,0:VERTEXMAXCOEFS-1,MAXLWFSIZE)
      COMPLEX*32 OUT(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
      INTEGER LCUT_SIZE,IN_SIZE,OUT_SIZE

      DO I=1,LCUT_SIZE
        DO J=1,OUT_SIZE
          DO K=0,14
            OUT(J,K,I)=CMPLX(0.0E0_16,0.0E0_16,KIND=16)
          ENDDO
          DO K=1,IN_SIZE
            OUT(J,0,I)=OUT(J,0,I)+A(K,0,I)*B(J,0,K)
            OUT(J,1,I)=OUT(J,1,I)+A(K,0,I)*B(J,1,K)
            OUT(J,2,I)=OUT(J,2,I)+A(K,0,I)*B(J,2,K)
            OUT(J,3,I)=OUT(J,3,I)+A(K,0,I)*B(J,3,K)
            OUT(J,4,I)=OUT(J,4,I)+A(K,0,I)*B(J,4,K)
            OUT(J,5,I)=OUT(J,5,I)+A(K,0,I)*B(J,5,K)
            OUT(J,6,I)=OUT(J,6,I)+A(K,0,I)*B(J,6,K)
            OUT(J,7,I)=OUT(J,7,I)+A(K,0,I)*B(J,7,K)
            OUT(J,8,I)=OUT(J,8,I)+A(K,0,I)*B(J,8,K)
            OUT(J,9,I)=OUT(J,9,I)+A(K,0,I)*B(J,9,K)
            OUT(J,10,I)=OUT(J,10,I)+A(K,0,I)*B(J,10,K)
            OUT(J,11,I)=OUT(J,11,I)+A(K,0,I)*B(J,11,K)
            OUT(J,12,I)=OUT(J,12,I)+A(K,0,I)*B(J,12,K)
            OUT(J,13,I)=OUT(J,13,I)+A(K,0,I)*B(J,13,K)
            OUT(J,14,I)=OUT(J,14,I)+A(K,0,I)*B(J,14,K)
          ENDDO
        ENDDO
      ENDDO
      END
